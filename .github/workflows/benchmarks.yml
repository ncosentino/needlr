name: Benchmarks

on:
  # Manual trigger
  workflow_dispatch:
  # Weekly on Sunday at 3am UTC
  schedule:
    - cron: '0 3 * * 0'

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes since last benchmark
        id: check
        run: |
          # Fetch gh-pages branch if it exists
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          
          # Try to get last benchmarked commit
          LAST_COMMIT=$(git show gh-pages:.last-benchmark-commit 2>/dev/null || echo "")
          
          echo "Last benchmarked commit: $LAST_COMMIT"
          echo "Current commit: ${{ github.sha }}"
          
          # For manual trigger, always run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - running benchmarks"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [ -z "$LAST_COMMIT" ]; then
            echo "No previous benchmark found - running benchmarks"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [ "$LAST_COMMIT" = "${{ github.sha }}" ]; then
            echo "No changes since last benchmark - skipping"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected - running benchmarks"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  run-benchmarks:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore src/NexusLabs.Needlr.Benchmarks/NexusLabs.Needlr.Benchmarks.csproj

      - name: Build Benchmarks
        run: dotnet build src/NexusLabs.Needlr.Benchmarks/NexusLabs.Needlr.Benchmarks.csproj -c Release --no-restore

      - name: Run Benchmarks
        run: |
          cd src/NexusLabs.Needlr.Benchmarks
          dotnet run -c Release --no-build -- \
            --filter '*' \
            --exporters json markdown html \
            --artifacts ../../benchmark-results

      - name: Prepare Benchmark JSON for Web
        run: |
          # BenchmarkDotNet creates one JSON file per benchmark class.
          # We need to merge all results into a single combined file.
          # Use jq to merge all Benchmarks arrays from all report files.
          
          cd benchmark-results
          
          # Find all full-compressed JSON files and merge their Benchmarks arrays
          JSON_FILES=$(find . -name '*-report-full-compressed.json' -type f)
          
          if [ -n "$JSON_FILES" ]; then
            # Create merged JSON with all benchmarks
            echo "$JSON_FILES" | xargs cat | jq -s '{
              Title: "Needlr Benchmarks",
              HostEnvironmentInfo: .[0].HostEnvironmentInfo,
              Benchmarks: [.[].Benchmarks[]]
            }' > results.json
          else
            echo '{"Benchmarks":[]}' > results.json
          fi
          
          cd ..

      - name: Upload Benchmark Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results/

      - name: Setup Python for MkDocs
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install MkDocs
        run: pip install mkdocs-material

      - name: Build Documentation
        run: python -m mkdocs build

      - name: Prepare Benchmark Results for Pages
        run: |
          # Create benchmarks directory in site
          mkdir -p site/benchmarks/results
          
          # Copy all benchmark results including the results.json for the web page
          cp -r benchmark-results/* site/benchmarks/ 2>/dev/null || true
          cp benchmark-results/results.json site/benchmarks/results/results.json 2>/dev/null || true

      - name: Save Last Benchmark Commit
        run: echo "${{ github.sha }}" > site/.last-benchmark-commit

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true
